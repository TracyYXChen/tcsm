from os.path import join
include: "../Snakefile"

subworkflow TCGAHR:
    workdir: "../TCGA-HR-experiment"

OUTPUT_DIR = 'processed'

STM_ALL_COUNT_EXPOSURES_FILE=join(OUTPUT_DIR, 'stm-all-count-exposures_{covariates}_{K}_TCGA-BRCA.tsv')
STM_TEST_COUNT_EXPOSURES_FILE=join(OUTPUT_DIR, 'stm-test-count-exposures_{covariates}_{K}_TCGA-BRCA_{fold}.tsv')
STM_TRAIN_COUNT_EXPOSURES_FILE=join(OUTPUT_DIR, 'stm-train-count-exposures_{covariates}_{K}_TCGA-BRCA_{fold}.tsv')

STM_ALL_EXPOSURES_FILE=join(OUTPUT_DIR, '{model}-all-{norm}-exposures_{covariates}_{K}_TCGA-BRCA.tsv')
STM_TEST_EXPOSURES_FILE=join(OUTPUT_DIR, '{model}-test-{norm}-exposures_{covariates}_{K}_TCGA-BRCA_{fold}.tsv')
STM_TRAIN_EXPOSURES_FILE=join(OUTPUT_DIR, '{model}-train-{norm}-exposures_{covariates}_{K}_TCGA-BRCA_{fold}.tsv')
STM_TRAIN_SIGNATURES_FILE=join(OUTPUT_DIR, 'stm-train-signatures_{covariates}_{K}_TCGA-BRCA_{fold}.tsv')

TEST_FEATURE_FILE=join(OUTPUT_DIR, "features-test_TCGA-BRCA_{fold}.tsv")
TRAIN_FEATURE_FILE=join(OUTPUT_DIR, "features-train_TCGA-BRCA_{fold}.tsv")
FEATURE_FILE=join(OUTPUT_DIR, "features-all_TCGA-BRCA.tsv")
MC_FILE=join(OUTPUT_DIR, "mutation-count-all_TCGA-BRCA.tsv")

# HELDOUT_AUC_FILE=join(OUTPUT_DIR, 'linear-svm-heldout-auc_{covariates}_{K}.pdf')
# IN_SAMPLE_AUC_FILE=join(OUTPUT_DIR, 'linear-svm-auc_{covariates}_{K}.pdf')
IN_SAMPLE_PR_FILE=join(OUTPUT_DIR, 'linear-svm-in-sample-pr_{norm}_{model}_{covariates}_{K}.tsv')
IN_SAMPLE_PR_FILE_MC=join(OUTPUT_DIR, 'linear-svm-pr_mutation_counts.tsv')
IN_SAMPLE_PR_LST_FILE=join(OUTPUT_DIR, 'linear-svm-pr_lst.tsv')
HELDOUT_PR_FILE=join(OUTPUT_DIR, 'linear-svm-heldout-pr_{norm}_{model}_{covariates}_{K}.tsv')
CORRELATION_FILE=join(OUTPUT_DIR, 'correlation_{topic}_{norm}_{model}_{covariates}_{K}.tsv')

# S1 = STM_TRAIN_SIGNATURES_FILE.format(covariates="NULL", K=6, fold=0)
# S2 = STM_TRAIN_SIGNATURES_FILE.format(covariates="NULL", K=6, fold=3)
# SIG_COSINE_PLOT =join(OUTPUT_DIR, "cosine-similarity-null-0-3.pdf")
# SIG_COSINE_SIM =join(OUTPUT_DIR, "cosine-similarity-null-0-3.tsv")

predictive_covariates = ["biBRCA1", "biBRCA2", "esBRCA1", "esRAD51C"]
combined_covariates = "+".join(predictive_covariates)

N_FOLDS=5
FOLDS=range(0, N_FOLDS)

K=[5]
rule predict_all:
    input:
        #expand(IN_SAMPLE_PR_FILE, model="stm", covariates=["LST", "NULL", "BRCA1BRCA2RAD51C"], K=K, norm=['normalized']),
        # expand(CORRELATION_FILE, model="stm", covariates=["NULL", "BRCA1BRCA2RAD51C"], K=K, norm=['normalized'], topic="Topic2"),
        # expand(CORRELATION_FILE, model="SS", covariates="NULL", K=K, norm=['normalized'], topic="S5"),
        #expand(IN_SAMPLE_PR_FILE, model="SS", covariates=["NULL"], K=K, norm=['normalized']),
        # IN_SAMPLE_PR_FILE_MC,
        # IN_SAMPLE_PR_LST_FILE,
        expand(HELDOUT_PR_FILE, covariates=["NULL"], K=K, norm=['normalized'], model="SS"),
        #STM_TEST_COUNT_EXPOSURES_FILE,
        #STM_TRAIN_COUNT_EXPOSURES_FILE
        # OVERALL_HELDOUT_PREDICTION_ACCURACY_FILE,
        # IN_SAMPLE_PR_FILE_MC
        # expand(HELDOUT_PR_FILE, covariates=["NULL", "BRCA12"], K=6),
        # expand(HELDOUT_AUC_FILE, covariates=["BRCA12", "NULL"], K=6)

# rule cal_cosine_similarity:
#     input:
#         S1,
#         S2
#     output:
#         SIG_COSINE_PLOT,
#         SIG_COSINE_SIM
#     script:
#         "../signature-visualization/src/plot_cosine_similarity.py"


rule in_sample_correlation:
    input:
        TCGAHR(STM_ALL_EXPOSURES_FILE),
        TCGAHR(FEATURE_FILE)
    output:
        CORRELATION_FILE
    script:
        "src/calculate_topic_LST_correlation.py"


rule in_sample_PR_LST:
    input:
        TCGAHR(FEATURE_FILE)
    output:
        IN_SAMPLE_PR_LST_FILE
    script:
        "src/run_LinearSVC_CV_LST_PR.py"

rule in_sample_PR_mutation_counts:
    input:
        TCGAHR(MC_FILE),
        TCGAHR(FEATURE_FILE)
    output:
        IN_SAMPLE_PR_FILE_MC
    script:
        "src/run_LinearSVC_CV_PR.py"

rule in_sample_PR:
    input:
        TCGAHR(STM_ALL_EXPOSURES_FILE),
        TCGAHR(FEATURE_FILE)
    output:
        IN_SAMPLE_PR_FILE
    script:
        "src/run_LinearSVC_CV_PR.py"

rule heldout_PR:
    input:
        TCGAHR(expand(STM_TRAIN_EXPOSURES_FILE, model="{model}", norm="{norm}", covariates="{covariates}", K="{K}", fold=FOLDS)),
        TCGAHR(expand(STM_TEST_EXPOSURES_FILE, model="{model}", norm="{norm}", covariates="{covariates}", K="{K}", fold=FOLDS)),
        TCGAHR(expand(TRAIN_FEATURE_FILE, covariates="{covariates}", K="{K}", fold=FOLDS)),
        TCGAHR(expand(TEST_FEATURE_FILE, covariates="{covariates}", K="{K}", fold=FOLDS))
    output:
        HELDOUT_PR_FILE
    script:
        "src/run_LinearSVC_PR.py"


# rule in_sample_AUC:
#     input:
#         STM_NORMALIZED_EXPOSURES_FILE,
#         FEATURE_FILE
#     output:
#         IN_SAMPLE_AUC_FILE
#     script:
#         "src/run_LinearSVC_CV_AUC_ROC.py"

# rule combine_prediction_accuracy:
#     input:
#         expand(HELDOUT_PREDICTION_ACCURACY_FILE, covariates=["BRCA12", "NULL"], K=5, fold=FOLDS)
#     output:
#         OVERALL_HELDOUT_PREDICTION_ACCURACY_FILE
#     script:
#         "src/combine_prediction_accuracy.py"



# rule heldout_AUC:
#     input:
#         expand(STM_TRAIN_EXPOSURES_FILE, covariates="{covariates}", K="{K}", fold=FOLDS),
#         expand(STM_TEST_EXPOSURES_FILE, covariates="{covariates}", K="{K}", fold=FOLDS),
#         expand(TRAIN_FEATURE_FILE, covariates="{covariates}", K="{K}", fold=FOLDS),
#         expand(TEST_FEATURE_FILE, covariates="{covariates}", K="{K}", fold=FOLDS)
#     output:
#         HELDOUT_AUC_FILE
#     script:
#         "src/run_LinearSVC_AUC_ROC.py"
